Система типов
=============

**УСТАРЕЛО** Скоро будет перенесено в Wiki проекта.

### Примитивы

Есть три базовых типа:

  * scalar
  * nodeset
  * boolean

Соответственно, примитивные значения:

  * строки ("Hello") и числа (42) -- тип scalar;
  * jpath (/foo/bar) -- тип nodeset;
  * у boolean'а нет примитивных значений.

### Приведение типов

Типы приводятся так и никак больше:

    nodeset     -> scalar
    nodeset     -> boolean
    scalar      -> boolean

В частности, `boolean` в данный момент не приводится к `scalar`.


### Операции над примитивами

Арифметические, логические и операции сравнения имеют такие сигнатуры:

    +       scalar, scalar      -> scalar
    -
    *
    /
    %

    ||      boolean, boolean    -> boolean
    &&
    !

    |       nodeset, nodeset    -> nodeset

    ==      scalar, scalar      -> boolean
    !=

    <       scalar, scalar      -> boolean
    <=
    >
    >=


### Тип блока

Блок, это несколько выражений, заключенные в круглые или фигурные скобки.
Вот примеры блоков:

    match / { // Тело шаблона.
        ...
    }

    function foo() { // Тело функции.
        ...
    }

    if (42) { // Блок then и else (если есть).
        ...
    } else {
        ...
    }

    for item { // Тело цикла.
        ...
    }

    $a = ( // Сложное выражение.
        ...
    )

Правило такое:
  * Если блок состоит ровно из одного выражения, то тип блока совпадает с типом этого выражения.
  * В остальных случаях, блок имеет тип scalar.


При этом, по необходимости весь блок приводится к нужному тип. Например:

    for items/item {
        title // Это nodeset.
              // Весь блок состоит из одного выражения, значит тип блока -- nodeset.
              // При этом сам for имеет тип scalar.
              // Значит все выражения должны быть приведены к типу scalar.
    }


### Типы блочных выражений

#### match

Блок тела шаблона приводится к типу scalar.

#### apply и for

У этих выражений тип всегда scalar.

#### if

Если блок else отсутствует, то тип -- scalar.
Если же присутствует, то "минимальный" общий тип, к которому приводятся типы блоков then и else.

#### list

Список inline-выражений, например:

    "Hello", username // Тип scalar.

или просто

    username // Тип nodeset.

Если выражений несколько, то scalar, иначе, тип этого одного выражения.


### Значение, возвращаемое функцией

Тип блока, составляющего тело функции и есть тип возвращаемого значения.

    function foo() {
        /foo/bar // Тип nodeset.
    }

    function foo() {
        "Hello" // Тип scalar.
    }

    function foo($x) {
        $x > 0 // Тип boolean.
    }

Тонкий момент.

    function foo(x) {
        $x // Ошибка. У параметров тип undef.
           // Переменные можно использовать только в составе выражений.
           // Например, $x + 1 имеет тип scalar. Потому что + всегда имеет тип scalar.
    }

